<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:x="http://www.jenitennison.com/xslt/xspec"
    xmlns:flub="http://data.ub.uib.no/xsl/function-library"
    xmlns:marc="http://www.loc.gov/MARC21/slim"
    stylesheet="../metalib2marc.xsl">
    <x:param name="institution" select="'UBB'"/>    
    <x:param name="id-list" select="false()"/>
    <x:scenario label="Scenario for testing template with match '*:file">
        <x:context><file xmlns="http://www.loc.gov/standards/marcxml/schema/MARC21slim.xsd"
            
           >        
        </file></x:context>
        <x:expect label="Expecting file element to be stripped and replaced with a root element &lt;collection&gt; in xmlns='http://www.loc.gov/MARC21/slim'" test="count(/marc:collection[not(*)])=1">
            <!--<collection xmlns="http://www.loc.gov/MARC21/slim" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>-->  
        </x:expect>
    </x:scenario>
    
    <x:scenario label="Scenario for testing multiple of same main category, and different sub categories">
        <x:context >
            <file>        
                <knowledge_unit>
                    <record  xmlns="http://www.loc.gov/MARC21/slim">
                        <controlfield tag="001">UNI01262</controlfield>
                        <datafield tag="245" ind1="1" ind2=" ">
                            <subfield code="a">Library of Congress</subfield>
                        </datafield>
                        <datafield tag='STA'><subfield code="a">ACTIVE</subfield></datafield>
                    </record>          
                <category>
                    <main>Tverrfagleg</main>
                    <sub>Bibliotekkatalogar</sub>
                    <main>Bibliotekinternt</main>
                    <sub>Bibliotekkataloger</sub>
                    <main>Bibliotekinternt</main>
                    <sub>Fjernlån - internasj.</sub>
                </category>
                </knowledge_unit>
            </file>
        </x:context>
        <x:expect label="expecting nested bibliotekkataloger" >
            <collection xmlns="http://www.loc.gov/MARC21/slim"
                xmlns:impl="urn:x-xspec:compile:xslt:impl"
                xmlns:flub="http://data.ub.uib.no/xsl/function-library">
                <record>
                    <leader> cai a2200000 u 4500</leader>                    
                    <controlfield tag="001">UNI01262</controlfield>
                    <controlfield tag="003">IL-JeEL</controlfield>
                    <controlfield tag="005">20170401105914.0</controlfield>
                    <controlfield tag="007">cr#|||||||||||</controlfield>
                    <controlfield tag="008">######c####9999xx#k|#d#o####|#####2###|c#</controlfield>
                    <datafield tag="035"
                        ind1=" "
                        ind2=" ">
                        <subfield code="a">(IL-JeEL)UNI01262</subfield>
                    </datafield>
                    <datafield tag="040" ind1=" " ind2=" ">
                        <subfield code="a">NO-TrBIB</subfield>
                        <subfield code="b">nob</subfield>
                        <subfield code="e">katreg</subfield>
                    </datafield>
                    <datafield tag="245" ind1="1" ind2=" ">
                        <subfield code="a">Library of Congress</subfield>
                    </datafield>
                    <datafield tag="920" ind1=" " ind2=" ">
                        <subfield code="a">Interdisciplinary resources</subfield>
                        <subfield code="b">Library catalogues</subfield>
                        <subfield code="5">UBB</subfield>
                        <subfield code="9">eng</subfield>
                        <subfield code="9">LOCAL</subfield>
                    </datafield>
                    <datafield tag="920" ind1=" " ind2=" ">
                        <subfield code="a">Tverrfaglig</subfield>
                        <subfield code="b">Bibliotekkataloger</subfield>
                        <subfield code="5">UBB</subfield>
                        <subfield code="9">nor</subfield>
                        <subfield code="9">LOCAL</subfield>                        
                    </datafield>
                    <datafield tag="920" ind1=" " ind2=" ">
                        <subfield code="a">For UB library staff</subfield>
                        <subfield code="b">Online Library catalogues</subfield>
                        <subfield code="b">Interlibrary loan - internat.</subfield>
                        <subfield code="5">UBB</subfield>
                        <subfield code="9">eng</subfield>
                        <subfield code="9">LOCAL</subfield>                        
                    </datafield>
                    <datafield tag="920" ind1=" " ind2=" ">
                        <subfield code="a">Bibliotekinternt</subfield>
                        <subfield code="b">Bibliotekkataloger</subfield>
                        <subfield code="b">Fjernlån - Internasj.</subfield>
                        <subfield code="5">UBB</subfield>
                        <subfield code="9">nor</subfield>
                        <subfield code="9">LOCAL</subfield>                        
                    </datafield>
                </record>
            </collection>
        </x:expect>
    </x:scenario>

    <x:scenario label="Scenario for testing template with match '*">
        <x:context>
            <file xmlns="http://www.loc.gov/standards/marcxml/schema/MARC21slim.xsd"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://www.loc.gov/standards/marcxml/schema/MARC21slim.xsd
                http://uniport.hosted.exlibrisgroup.com:80/aleph-cgi/load_schema.pl">   
            <knowledge_unit>
            </knowledge_unit>
            </file>
        </x:context>
        <x:expect label="Expecting &lt;knowledge_unit&gt; stripped and root element collection">
            <collection xmlns="http://www.loc.gov/MARC21/slim" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
        </x:expect>
    </x:scenario>

    <x:scenario label="Scenario for testing template with match 'text()' and mode 'copy'">
        <x:context mode="copy">                        
            <subfield xmlns="http://www.loc.gov/MARC21/slim" code="a">Eurobarometer</subfield>       
</x:context>
        <x:expect  label="Expecting subfield element copied with attribute and string copied">
            <subfield xmlns="http://www.loc.gov/MARC21/slim"                 
                xmlns:flub="http://data.ub.uib.no/xsl/function-library"
                code="a">Eurobarometer</subfield>
            
                        
</x:expect>
</x:scenario>

    <x:scenario
        label="Scenario for testing template with match '*' and mode 'copy'">
        <x:context mode="copy">                        
            <subfield code="a">Eurobarometer</subfield>       
        </x:context>
        <x:expect  label="Expecting subfield element copied with attribute and string copied">
            <subfield xmlns="http://www.loc.gov/MARC21/slim"                
                xmlns:flub="http://data.ub.uib.no/xsl/function-library"
                code="a">Eurobarometer</subfield>
            
            
        </x:expect></x:scenario>

    <x:scenario 
        label="Scenario for testing template with match '*:datafield[@tag=('531','532','574',         '575','591','592','593','594','595','901','902','956') and *:subfield/@code='a']   |         *:datafield[@tag='856']/*:subfield[@code=('$7','$D')]|         *:datafield[@tag='245']/*:subfield[@code='$9']' and mode 'copy #default'">
        <x:context mode="copy">
            <datafield tag="531"><subfield code="a">value</subfield></datafield>
        </x:context>
        <x:expect label="Expecting element datafield with @tag 531  and children removed (an empty sequence)" select="()"/>
    </x:scenario>

    <x:scenario label="Scenario for testing template with match '*:datafield[matches(@tag,'^[0-9]+')]">
        <x:context href="../examples.xml" select="//*:knowledge_unit[1]/*:record[1]/*:datafield[@tag='210']"/>
        <x:expect label="datafield 210 copied as is">
            <datafield xmlns="http://www.loc.gov/MARC21/slim"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xmlns:pkg="http://expath.org/ns/pkg"
                xmlns:flub="http://data.ub.uib.no/xsl/function-library"
                tag="210" ind1=" " ind2=" ">
                <subfield code="a">Eurobarometer</subfield>
            </datafield>
        </x:expect>
    </x:scenario>

    <x:scenario label="Scenario for testing template with match '*:datafield[@tag='520']|         *:datafield[@tag='245' and *:subfield/@code='a']|         *:datafield[@tag='246' and *:subfield/@code='a']|           *:datafield[@tag='260' and (*:subfield/@code='a' or *:subfield/@code='b')]">
        <x:context href="../examples.xml" select="//*:knowledge_unit[1]/*:record[1]/*:datafield[@tag='210']"/>
        <x:expect label="datafield 210 copied as is">
            <datafield xmlns="http://www.loc.gov/MARC21/slim" tag="210" ind1=" " ind2=" ">
                <subfield code="a">Eurobarometer</subfield>
            </datafield>
            
        </x:expect>
    </x:scenario>

    <x:scenario label="Scenario for testing function controlfield_008">
        <x:call template="controlfield_008"/>
        <x:expect label="controlfield added with k in position 18 (from 0)"><controlfield xmlns="http://www.loc.gov/MARC21/slim"
            xmlns:pkg="http://expath.org/ns/pkg"
            xmlns:impl="urn:x-xspec:compile:xslt:impl"
            xmlns:flub="http://data.ub.uib.no/xsl/function-library"
            tag="008">##################k##d#o##########2######</controlfield>
        </x:expect>
    </x:scenario>

    <x:scenario label="Scenario for testing template with match '*:record[*:datafield[@tag='STA']/*:subfield[@code='a']='ACTIVE']">
        <x:scenario label="with INACTIVE status">
            <x:context>
                <file>        
                    <knowledge_unit>
                        <record  xmlns="http://www.loc.gov/MARC21/slim">                           
                            <datafield tag='STA'><subfield code="a">INACTIVE</subfield></datafield>
                        </record>
                               </knowledge_unit>
                </file>
            </x:context>
            <x:expect label="no record copied. Empty collection element.">
                <collection xmlns="http://www.loc.gov/MARC21/slim"
                    xmlns:pkg="http://expath.org/ns/pkg"
                    xmlns:impl="urn:x-xspec:compile:xslt:impl"
                    xmlns:flub="http://data.ub.uib.no/xsl/function-library" />
                
            </x:expect>
        </x:scenario>
        <x:scenario label="with ACTIVE status">
          
            <x:context><file>        
                <knowledge_unit>
                    <record  xmlns="http://www.loc.gov/MARC21/slim">                           
                        <datafield tag='STA'><subfield code="a">ACTIVE</subfield></datafield>
                    </record>
                </knowledge_unit>
            </file>
            </x:context>
            <x:expect label="record added with leader and controlfield">
                <collection xmlns="http://www.loc.gov/MARC21/slim"
                xmlns:pkg="http://expath.org/ns/pkg"
                xmlns:impl="urn:x-xspec:compile:xslt:impl"
                xmlns:flub="http://data.ub.uib.no/xsl/function-library" > <record>
                    <leader>00000nai</leader>
                    <controlfield tag="008">##################k##d#o##########2######</controlfield>
                </record></collection></x:expect>
        </x:scenario>    
    </x:scenario>
 
    <x:scenario
        label="Scenario for testing template with match '*:datafield[@tag='856' and @ind1='4' and (@ind2='1' or @ind2='9') and subfield/@code='u']">
        <x:scenario label="ind2 is 1">
            <x:context href="../examples.xml" select="//*:knowledge_unit[4]/*:record/*:datafield[@tag='856' and @ind1='4' and @ind2='1']"/>
            <x:expect label="expecting field (main link on post) copied to controlfield 956"><datafield xmlns="http://www.loc.gov/MARC21/slim"
                xmlns:pkg="http://expath.org/ns/pkg"
                xmlns:impl="urn:x-xspec:compile:xslt:impl"
                xmlns:flub="http://data.ub.uib.no/xsl/function-library"
                tag="956"
                ind1=" "
                ind2=" ">
                <subfield code="u">http://www.ncbi.nlm.nih.gov/pubmed?otool=inoublib</subfield>
                <subfield code="5">UBB</subfield>
            </datafield></x:expect>
        </x:scenario>
       <x:scenario label="ind2 is 9">
           <x:context  href="../examples.xml" select="//*:knowledge_unit[4]/*:record/*:datafield[@tag='856' and @ind1='4' and @ind2='9']"/>
           <x:expect label="expecting field copied to 921"><datafield xmlns="http://www.loc.gov/MARC21/slim"
               xmlns:pkg="http://expath.org/ns/pkg"
               xmlns:impl="urn:x-xspec:compile:xslt:impl"
               xmlns:flub="http://data.ub.uib.no/xsl/function-library"
               tag="921"
               ind1=" "
               ind2=" ">
               <subfield code="u">http://www.ub.uib.no/felles/brosjyrer/pubmed-eng.pdf</subfield>
               <subfield code="5">UBB</subfield>
           </datafield></x:expect>
       </x:scenario>
       

        
        <!--<x:expect label="Not yet implemented" select="'Not yet implemented'"/>-->
    </x:scenario>

        <x:scenario 
        label="Scenario for testing template with match 'text()">
        <x:context>
            <record  xmlns="http://www.loc.gov/MARC21/slim">  
                TEST
                <datafield tag='STA'><subfield code="a">ACTIVE</subfield></datafield>
            </record>
        </x:context>
        <x:expect label="Expecting text node stripped" >
            <record xmlns="http://www.loc.gov/MARC21/slim"
                xmlns:pkg="http://expath.org/ns/pkg"
                xmlns:impl="urn:x-xspec:compile:xslt:impl"
                xmlns:flub="http://data.ub.uib.no/xsl/function-library">
                <leader>00000nai</leader>
                <controlfield tag="008">##################k##d#o##########2######</controlfield>
            </record>
        </x:expect>
    </x:scenario>

    <x:scenario  label="Scenario for testing template with match '*:record">
        <x:context>
            <file>        
                <knowledge_unit>
                    <record  xmlns="http://www.loc.gov/MARC21/slim">
                        <controlfield tag="001">UNI01262</controlfield>
                        <datafield tag="245" ind1="1" ind2="0">
                            <subfield code="a">Library of Congress</subfield>
                        </datafield>
                        <datafield tag='STA'><subfield code="a">INACTIVE</subfield></datafield>
                    </record>          
                    <category>
                        <main>Tverrfagleg</main>
                        <sub>Bibliotekkatalogar</sub>
                        <main>Bibliotekinternt</main>
                        <sub>Bibliotekkataloger</sub>
                        <main>Bibliotekinternt</main>
                        <sub>Fjernlån - internasj.</sub>
                    </category>
                </knowledge_unit>
            </file>
        </x:context>
        <x:expect label="Expecting empty collection element">
            <collection xmlns="http://www.loc.gov/MARC21/slim"
                xmlns:pkg="http://expath.org/ns/pkg"
                xmlns:impl="urn:x-xspec:compile:xslt:impl"
                xmlns:flub="http://data.ub.uib.no/xsl/function-library" />
        </x:expect>
    </x:scenario>

    <x:scenario  label="Scenario for testing function replaceFieldInPosition">
        <x:scenario label="$position=0">
        <x:call function="flub:replaceFieldInPosition">
            <x:param name="controlfield">
                <controlfield xmlns="http://www.loc.gov/MARC21/slim" tag="008">#########################################</controlfield>
            </x:param>
            <x:param name="position" select="0"/>
            <x:param name="insert_value" select="'a'"/>
        </x:call>
        <x:expect label="expecting a inserted on first #">
            <controlfield xmlns="http://www.loc.gov/MARC21/slim"
                xmlns:pkg="http://expath.org/ns/pkg"
                xmlns:impl="urn:x-xspec:compile:xslt:impl"
                xmlns:flub="http://data.ub.uib.no/xsl/function-library"
                tag="008">a########################################</controlfield>        </x:expect>
    </x:scenario>
    </x:scenario>

    <x:scenario label="Scenario for testing function subfield_code_5">
        
        <x:call template="subfield_code_5"/>
        <x:expect label="subfield with code 5 attribute, and global param institution (UBB) as text node" >
            <subfield  xmlns="http://www.loc.gov/MARC21/slim"
                xmlns:pkg="http://expath.org/ns/pkg"
                xmlns:impl="urn:x-xspec:compile:xslt:impl"
                xmlns:flub="http://data.ub.uib.no/xsl/function-library" code="5">UBB</subfield>
        </x:expect>
    </x:scenario>
   
    <x:scenario label="Feedback from bibsys">
    <x:scenario label="Testing 920 category without language tags ($9 reserved for local on import)">
        <x:scenario label="Ingen 900 felt med code='9' som er ulik local">
            <x:context href="../examples.xml"/>
            <x:expect label="0 " test="count(//marc:datafield[matches(@tag,'^9')]/marc:subfield[@code='9' and .='local'])=0"></x:expect>
        </x:scenario>
    </x:scenario>
    <x:scenario label="Adding 922 for description"> </x:scenario>    
    <x:scenario label="Select last language for bilingual strings."></x:scenario>
    <x:scenario label="520 with no translation regex"></x:scenario>
    <x:scenario label="OA markering 594 FREE"></x:scenario>
    <x:scenario label="OA markering (ezproxy lenke)"></x:scenario>
    <x:scenario label="Uten OA markering (ezproxy lenke)"></x:scenario>
    </x:scenario>
    
    <x:scenario label="feedback from Ketil">
        <x:scenario label="655 til 653">
            <x:context href="../examples.xml"/>
            <x:expect label="expecting 14 (10+4) 653 with $a" test="count(//marc:datafield[@tag='653'])=14"></x:expect>
        </x:scenario>
        <x:scenario label="110 $a til 260 $1 dersom forskjellig. Bare en dersom 260 og 210 er lik"></x:scenario>
        <x:scenario label="slett 210 dersom den er lik som 245, flytt til 246 (alternativ tittel dersom den ikke finnes). "></x:scenario>
        <x:scenario label="856">
            <x:scenario label="Ta inn igjen lenke fra 856 1 4 til 856 0 4. For network post."></x:scenario>
            <x:scenario label="$3 Fulltekst"/>
        </x:scenario>
        
        <x:scenario label="LDR 17 til 15 og 18 til c"/>
        <x:scenario label="007 til cr#||||||"/>
        <x:scenario label="008">
            <x:scenario label="06 til c">
            </x:scenario>
            <x:scenario label="11-14 9999"></x:scenario>
            <x:scenario label="19 28 29 og 38 til |"></x:scenario>
            <x:scenario label="039 til c"></x:scenario>
            
        </x:scenario>
        <x:scenario label="040 $$a NO-TrBIB $$b nob $$e katreg
            "></x:scenario>
        <x:scenario label="245 andreindikator til 0"></x:scenario>
    </x:scenario>
</x:description>
